REVISION = 3

print('cc-progs bootstrapper rev ' .. REVISION .. ' - Grissess')

local CC = os.loadAPI ~= nil
local HTTP_ROOT = "https://raw.githubusercontent.com/Grissess/cc-progs/master/"

print('Is ComputerCraft:', CC)
print('HTTP root:', HTTP_ROOT)

local DISK_ROOT
if CC then
	DISK_ROOT = "/disk"
else
	DISK_ROOT = "/usr"
end

local rand = math.floor(65536 * math.random())

local args = {...}

if args[1] ~= nil then
	DISK_ROOT = args[1]
end

print('Install root:', DISK_ROOT)

if CC then
	if http == nil then
		error("HTTP isn't supported, sorry")
	end
else
	internet = require('internet')
	filesystem = require('filesystem')
end

local resp
repeat
	print('Are these settings OK? [Y/n]')
	resp = io.read():lower()
until resp == '' or resp == 'y' or resp == 'n'

if resp == 'n' then
	error('Aborted.')
end

local MANIFEST
if CC then
	MANIFEST = "manifest.cc"
else
	MANIFEST = "manifest.oc"
end

print('Getting:', MANIFEST)


local function http_get(uri)
	if CC then
		local req = http.get(uri)
		if req == nil then
			print("Failed!")
		elseif req.getResponseCode() ~= 200 then
			print("Failed: HTTP status ", req.getResponseCode())
			req.close()
		end
		local buffer = req.readAll()
		req.close()
		return buffer
	else
		local buffer = ''
		for data in internet.request(uri) do
			buffer = buffer .. data
		end
		return buffer
	end
end
local man_str = http_get(HTTP_ROOT .. MANIFEST .. "?rand=" .. rand)

for line in man_str:gmatch("[^\r\n]+") do
	local dest, src = line:match("([^%s]+) ([^%s]+)")
	print('Downloading', src, 'to', dest)
	local data = http_get(HTTP_ROOT .. src .. "?rand=" .. rand)
	local lpath = fs.combine(DISK_ROOT, dest)
	print("Writing to ", lpath, "...")
	if CC then
		local f = fs.open(lpath, "w")
	else
		local f = filesystem.open(lpath, "w")
	end
	f.write(data)
	f.close()
	print("Done!")
end

print("Complete!")
